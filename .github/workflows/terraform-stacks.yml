# ============================================================
# terraform-stacks.yml
#
# O QUE É ESTE ARQUIVO?
# - Este é o workflow do GitHub Actions que executa o Terraform por “stacks” (pastas)
#   em ordem, usando autenticação por OIDC (sem salvar chaves fixas no GitHub).
#
# PARA QUE SERVE?
# - Automatiza o provisionamento da infraestrutura na AWS toda vez que você
#   faz push na branch main.
#
# COM QUEM ELE “CONVERSA”?
# - GitHub Actions: executa os comandos no runner ubuntu.
# - AWS STS + IAM (OIDC): assume a Role de permissão via federação.
# - S3 (Terraform State): armazena o histórico da infra (tfstate).
# - DynamoDB (State Lock): evita conflitos se duas pessoas tentarem aplicar juntas.
# - Terraform CLI: cria os recursos (VPC, EKS, RDS, etc.) em cada pasta.
#
# QUAL A RELEVÂNCIA?
# - Ordem de dependência garantida: networking -> security -> data -> compute...
# - Isolamento de falhas: se o EKS falhar, sua rede e seu banco já estão salvos e seguros.
# - Segurança Enterprise: OIDC usa tokens temporários, sem risco de vazamento de senhas.
# ============================================================

name: Terraform Stacks (OIDC) - Prod

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

concurrency:
  group: terraform-prod
  cancel-in-progress: false

env:
  AWS_REGION: ${{ vars.AWS_REGION }}
  AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_TO_ASSUME }}
  TF_STATE_BUCKET: toshiro-ecommerce-prod-tfstate
  TF_LOCK_TABLE: toshiro-ecommerce-prod-tfstate-lock
  TFVARS_FILE: ../env/prod.tfvars

jobs:

  # 00 - BOOTSTRAP
  bootstrap:
    name: 00-bootstrap
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: ${{ env.AWS_ROLE_ARN }}
          role-session-name: gha-terraform-prod-bootstrap
      - name: Apply 00-bootstrap
        working-directory: stacks/00-bootstrap
        run: |
          terraform init -reconfigure \
            -backend-config="bucket=${{ env.TF_STATE_BUCKET }}" \
            -backend-config="key=prod/00-bootstrap/terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}" \
            -backend-config="encrypt=true" \
            -backend-config="dynamodb_table=${{ env.TF_LOCK_TABLE }}"
          terraform apply -auto-approve -var-file=${{ env.TFVARS_FILE }}

  # 01 - NETWORKING
  networking:
    name: 01-networking
    needs: bootstrap
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: ${{ env.AWS_ROLE_ARN }}
      - name: Apply 01-networking
        working-directory: stacks/networking
        run: |
          terraform init -reconfigure \
            -backend-config="bucket=${{ env.TF_STATE_BUCKET }}" \
            -backend-config="key=prod/networking/terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}" \
            -backend-config="encrypt=true" \
            -backend-config="dynamodb_table=${{ env.TF_LOCK_TABLE }}"
          terraform apply -auto-approve -var-file=${{ env.TFVARS_FILE }}

  # 02 - SECURITY
  security:
    name: 02-security
    needs: networking
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: ${{ env.AWS_ROLE_ARN }}
      - name: Apply 02-security
        working-directory: stacks/security
        run: |
          terraform init -reconfigure \
            -backend-config="bucket=${{ env.TF_STATE_BUCKET }}" \
            -backend-config="key=prod/security/terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}" \
            -backend-config="encrypt=true" \
            -backend-config="dynamodb_table=${{ env.TF_LOCK_TABLE }}"
          terraform apply -auto-approve -var-file=${{ env.TFVARS_FILE }}

  # 03 - DATA
  data:
    name: 03-data
    needs: security
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: ${{ env.AWS_ROLE_ARN }}
      - name: Apply 03-data
        working-directory: stacks/data
        run: |
          terraform init -reconfigure \
            -backend-config="bucket=${{ env.TF_STATE_BUCKET }}" \
            -backend-config="key=prod/data/terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}" \
            -backend-config="encrypt=true" \
            -backend-config="dynamodb_table=${{ env.TF_LOCK_TABLE }}"
          terraform apply -auto-approve -var-file=${{ env.TFVARS_FILE }}

  # 04 - COMPUTE EKS
  compute_eks:
    name: 04-compute-eks
    needs: data
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: ${{ env.AWS_ROLE_ARN }}
      - name: Apply 04-compute-eks
        working-directory: stacks/compute-eks
        run: |
          terraform init -reconfigure \
            -backend-config="bucket=${{ env.TF_STATE_BUCKET }}" \
            -backend-config="key=prod/compute-eks/terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}" \
            -backend-config="encrypt=true" \
            -backend-config="dynamodb_table=${{ env.TF_LOCK_TABLE }}"
          terraform apply -auto-approve -var-file=${{ env.TFVARS_FILE }}

  # 05 - K8S ADDONS
  k8s_addons:
    name: 05-k8s-addons
    needs: compute_eks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: ${{ env.AWS_ROLE_ARN }}
      - name: Apply 05-k8s-addons
        working-directory: stacks/k8s-addons
        run: |
          terraform init -reconfigure \
            -backend-config="bucket=${{ env.TF_STATE_BUCKET }}" \
            -backend-config="key=prod/k8s-addons/terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}" \
            -backend-config="encrypt=true" \
            -backend-config="dynamodb_table=${{ env.TF_LOCK_TABLE }}"
          terraform apply -auto-approve -var-file=${{ env.TFVARS_FILE }}

  # 06 - EDGE DELIVERY
  edge_delivery:
    name: 06-edge-delivery
    needs: k8s_addons
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: ${{ env.AWS_ROLE_ARN }}
      - name: Apply 06-edge-delivery
        working-directory: stacks/edge-delivery
        run: |
          terraform init -reconfigure \
            -backend-config="bucket=${{ env.TF_STATE_BUCKET }}" \
            -backend-config="key=prod/edge-delivery/terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}" \
            -backend-config="encrypt=true" \
            -backend-config="dynamodb_table=${{ env.TF_LOCK_TABLE }}"
          terraform apply -auto-approve -var-file=${{ env.TFVARS_FILE }}

  # 07 - DNS GLOBAL
  dns_global:
    name: 07-dns-global
    needs: edge_delivery
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: ${{ env.AWS_ROLE_ARN }}
      - name: Apply 07-dns-global
        working-directory: stacks/dns-global
        run: |
          terraform init -reconfigure \
            -backend-config="bucket=${{ env.TF_STATE_BUCKET }}" \
            -backend-config="key=prod/dns-global/terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}" \
            -backend-config="encrypt=true" \
            -backend-config="dynamodb_table=${{ env.TF_LOCK_TABLE }}"
          terraform apply -auto-approve -var-file=${{ env.TFVARS_FILE }}

  # 08 - OBSERVABILITY
  observability:
    name: 08-observability
    needs: dns_global
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: ${{ env.AWS_ROLE_ARN }}
      - name: Apply 08-observability
        working-directory: stacks/observability
        run: |
          terraform init -reconfigure \
            -backend-config="bucket=${{ env.TF_STATE_BUCKET }}" \
            -backend-config="key=prod/observability/terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}" \
            -backend-config="encrypt=true" \
            -backend-config="dynamodb_table=${{ env.TF_LOCK_TABLE }}"
          terraform apply -auto-approve -var-file=${{ env.TFVARS_FILE }}

  # 09 - GOVERNANCE
  governance:
    name: 09-governance
    needs: observability
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: ${{ env.AWS_ROLE_ARN }}
      - name: Apply 09-governance
        working-directory: stacks/governance
        run: |
          terraform init -reconfigure \
            -backend-config="bucket=${{ env.TF_STATE_BUCKET }}" \
            -backend-config="key=prod/governance/terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}" \
            -backend-config="encrypt=true" \
            -backend-config="dynamodb_table=${{ env.TF_LOCK_TABLE }}"
          terraform apply -auto-approve -var-file=${{ env.TFVARS_FILE }}